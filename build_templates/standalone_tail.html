/* END OF DATASET INJECTION - closing dataset script */
</script>

<script>
  // Conservative normalization and changelog
  (function normalizeAndInit(){
    const changelog = [];
    function note(qid, field, before, after){ changelog.push({id: qid, field, before, after}); }

    if (!window.testData || typeof window.testData !== 'object') {
      document.getElementById('summary').innerText = 'Error: dataset not found.';
      return;
    }

    let totalQuestions = 0;
    Object.keys(window.testData).forEach(catKey => {
      const cat = window.testData[catKey];
      if (!cat || !Array.isArray(cat.tests)) return;
      cat.tests.forEach(test => {
        if (!test || !Array.isArray(test.questions)) return;
        test.questions.forEach(q => {
          totalQuestions++;
          const qid = q && (q.id || `${catKey}:${test.id}`);

          // Normalize correct: must be integer 0..(options.length-1)
          const beforeCorrect = q.hasOwnProperty('correct') ? q.correct : null;
          let ok = true;
          if (typeof beforeCorrect !== 'number' || !isFinite(beforeCorrect) ) ok = false;
          else if (beforeCorrect < 0) ok = false;
          else if (!Array.isArray(q.options) || beforeCorrect >= q.options.length) ok = false;

          if (!ok) {
            if (beforeCorrect !== null) note(qid, 'correct', beforeCorrect, null);
            q.correct = null;
          } else {
            // clamp to integer
            const clamped = Math.floor(beforeCorrect);
            if (clamped !== beforeCorrect){ note(qid,'correct',beforeCorrect,clamped); q.correct = clamped; }
          }

          // If answer string is empty/null, do not invent it; but nullify correct to avoid mapping errors
          const beforeAnswer = q.hasOwnProperty('answer') ? q.answer : null;
          if (typeof beforeAnswer !== 'string' || beforeAnswer.trim() === ''){
            if (q.correct !== null){ note(qid,'answer', beforeAnswer, null); }
            q.answer = (typeof beforeAnswer === 'string') ? '' : '';
          }
        });
      });
    });

    window.datasetChangelog = changelog;

    // Simple UI rendering
    const summary = document.getElementById('summary');
    summary.innerHTML = '';

    const meta = document.createElement('div');
    meta.innerHTML = `<strong>Dataset loaded.</strong> Categories: ${Object.keys(window.testData).length}, Questions: ${totalQuestions}`;
    summary.appendChild(meta);

    const catList = document.createElement('div');
    for (const catKey of Object.keys(window.testData)){
      const cat = window.testData[catKey];
      const btn = document.createElement('button');
      btn.textContent = cat.name || catKey;
      btn.addEventListener('click', ()=> renderCategory(catKey));
      catList.appendChild(btn);
    }
    summary.appendChild(catList);

    // changelog viewer
    const changelogEl = document.createElement('div');
    changelogEl.style.marginTop = '1rem';
    changelogEl.innerHTML = '<h3>Normalization changelog (conservative)</h3>';
    const pre = document.createElement('pre'); pre.className='changelog'; pre.textContent = JSON.stringify(changelog, null, 2);
    changelogEl.appendChild(pre);
    summary.appendChild(changelogEl);

    document.getElementById('btn-export').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(changelog, null, 2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'dataset-changelog.json'; a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('btn-refresh').addEventListener('click', ()=> location.reload());

    function safeLetter(idx){ if (typeof idx!=='number' || !isFinite(idx) || idx<0) return ''; return String.fromCharCode(65 + Math.floor(idx)); }

    function renderCategory(catKey){
      const container = document.createElement('div');
      container.innerHTML = `<h2>${window.testData[catKey].name || catKey}</h2>`;
      window.testData[catKey].tests.forEach(test=>{
        const h = document.createElement('h3'); h.textContent = test.name || test.id; container.appendChild(h);
        test.questions.forEach(q=>{
          const qEl = document.createElement('div'); qEl.className='question';
          const qt = document.createElement('div'); qt.className='qtext'; qt.textContent = q.question || '(no question text)'; qEl.appendChild(qt);
          q.options && q.options.forEach((opt,i)=>{
            const optEl = document.createElement('div'); optEl.className='option';
            const letter = document.createElement('div'); letter.className='option-letter'; letter.textContent = safeLetter(i);
            const txt = document.createElement('div'); txt.className='option-text'; txt.textContent = opt;
            optEl.appendChild(letter); optEl.appendChild(txt);
            qEl.appendChild(optEl);
          });
          container.appendChild(qEl);
        });
      });
      // replace summary with category view
      summary.parentNode.replaceChild(container, summary);
    }

  })();
</script>

</div>
</body>
</html>
